## Airi における「自発的な会話開始（Proactive Prompts）」の実現方式

これは、ユーザーからの明示的な入力（チャットや音声）が無い場合でも、Airi の AI が自発的に会話を投げかける機能（以下「プロアクティブ機能」）の実装方式のまとめです。

目的
- ユーザーの利用促進、エンゲージメント向上
- ユーザーが気付かない問題や提案を提示することで利便性を高める
- 過剰な割り込みを避け、ユーザー体験を損なわない

重要な設計方針
- プライバシー尊重：ユーザー同意やオプトイン/オプトアウト設定を必須にする
- コンテキスト重視：会話履歴、アプリ状態、時間帯、ユーザー設定をもとに発話の必要性を判定する
- 最小侵襲性：通知やメッセージの頻度を制御し、明確な停止手段を提供する

実現方式の一覧（要約）
- タイムベースのトリガー
  - 定期的に（例：毎朝、一定時間アイドル状態）ユーザーに問いかける
  - 利点：実装が簡単、スケジュールベースで予測可能
  - 欠点：無関心なユーザーには不要な割り込みになりやすい

- イベントベースのトリガー
  - アプリ内イベント（新機能、エラー、未完了タスク、外部サービスの状態変化）を検知してプロアクティブに通知
  - 利点：関連性が高く、ユーザー価値が出やすい
  - 欠点：イベント設計とノイズ制御が必要

- コンテキスト/シグナル駆動のトリガー（推奨）
  - ユーザーの過去の行動、会話履歴、現在の画面、時間帯、位置情報（許可がある場合）など複数シグナルを統合してトリガー判定（スコアリング）
  - 利点：高い関連性とパーソナライズ
  - 欠点：実装が複雑、プライバシー配慮が必要

- モデルによる生成・計画トリガー
  - LLM や RL（強化学習）を利用して、ユーザーに価値のある会話を自律的に決定（例：ユーザーのゴールに基づく提案やリマインダー）
  - 利点：柔軟で高度な判断が可能
  - 欠点：予測不可能な発話や費用（APIコスト）、安全性の課題

- ハイブリッド方式
  - 上記を組み合わせ、まずシグナルスコアで候補を選定し、LLMで自然なメッセージを生成して配信する流れが現実的

設計の細かい要素

- ユーザー設定と合意管理
  - デフォルトをオフかつ明確なオンボードでオプトインを促す
  - ユーザー別に頻度/カテゴリ/チャネル（通知・チャット・音声）を設定可能にする

- 割り込みの制御
  - サイレント時間帯（Do Not Disturb）を尊重
  - 冗長な繰り返しを避けるためのレート制限と冷却期間
  - 重要度スコアに基づく階層化（緊急のみプッシュ、低優先はバッジや履歴に蓄積）

- メッセージ品質と安全性
  - 生成メッセージはテンプレート＋LLM 微調整で安全性を確保
  - フィルタリング（不適切/誤情報の除去）、検証済みデータへの参照を付与

- 実装パターンとアーキテクチャ
  - シンプル版（早めに試す）
    - スケジューラ（cron）やクライアント側タイマーで定期トリガー
    - サーバーで状態を評価して通知を送信（WebSocket / Push / Email）

  - 推奨版（運用向け）
    - イベント収集層（イベントバス / Kafka / PubSub）とリアルタイムストリーム処理（Flink / ksqlDB / Beam）
    - シグナル集約サービス（ユーザー行動のスコアリングマイクロサービス）
    - ポリシーエンジン（ユーザー許可、レート制限、DND判定）
    - メッセージ生成層（テンプレート＋LLM）、配信層（Push、WebSocket、SSE、メール、音声）

- データとプライバシー
  - 最小限のデータ保持、ユーザーコントロール、ログの匿名化
  - GDPR/地域法対応、監査ログの保持と削除ポリシー

- 評価と計測
  - KPI：エンゲージメント率、離脱率、オプトアウト率、誤発話率（誤通知）
  - A/B テストで頻度やテンプレートを評価

実装手順（小さく始める例）
1. プロトタイプ設計
   - 最低限のトリガー（例：一定時間アイドル→「何かお手伝いできますか？」）を作る
   - ユーザーのオプトインを確認する UI を実装
2. 収集と計測
   - トリガー発生、ユーザー反応、オプトアウトを記録する
3. シグナルとルールの追加
   - 行動履歴やイベントベーストリガーを導入
4. LLM を使ったメッセージ生成の導入
   - テンプレート＋LLM サイドチェックで安全性を担保
5. 拡張と最適化
   - A/B テスト、システム全体のスコアリング最適化、コスト管理

考慮すべきリスク
- スパム化とユーザー離脱
- プライバシー/法令違反
- 誤情報・誤発話による信頼失墜
- コスト増（LLM API 呼び出し）

参考実装アイデア
- クライアント主導（軽量）: クライアントでアイドル判定してサーバーにイベント送信、サーバーは軽い返信テンプレートを返す
- サーバー主導（推奨）: サーバーで多くのシグナルを集約してスコアリングし、関連性が高い場合のみクライアントにプッシュ
- オフライン/バッチ通知: 深夜やユーザー非アクティブ時はまとめ通知をメールやダイジェストで送る

次のステップ
- このドキュメントをレビューし、優先度の高いトリガー（例：未完了タスク、セキュリティ重要イベント）を実装候補として選定してください
- 実装時は小さな実験（1-2個のトリガー、A/B）でユーザーレスポンスを測定することを推奨します

関連資料
- プロダクト設計: ユーザー許可とオンボーディングのベストプラクティス
- 技術設計: イベント駆動アーキテクチャ入門

作成日: 2026-01-07
